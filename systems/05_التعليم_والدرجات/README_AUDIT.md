# ğŸ”’ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ø­ÙˆÙƒÙ…Ø©
## DDL_AUDIT â€” Audit Trail & Governance

---

## ğŸ“Œ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ù
| Ø§Ù„Ø¨Ù†Ø¯ | Ø§Ù„Ù‚ÙŠÙ…Ø© |
|-------|--------|
| **Ø§Ù„Ù…Ù„Ù** | `DDL_AUDIT.sql` |
| **ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†ÙÙŠØ°** | 7ï¸âƒ£ Ø§Ù„Ø£Ø®ÙŠØ± |
| **Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±** | 1 Ø¬Ø¯ÙˆÙ„ + 5 Triggers |
| **ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰** | Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª DDL Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© |

---

## ğŸš€ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ù‡ÙŠ **Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…ÙŠÙ†** Ù„Ù„Ø¯Ø±Ø¬Ø§Øª. Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠÙ…Ù†Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙˆÙŠØ³Ø¬Ù‘Ù„ ÙƒÙ„ ØªØºÙŠÙŠØ± ÙÙŠ Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ Ù„Ø§ ÙŠÙÙ…Ø­Ù‰. **Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ø£Ø­Ø¯ ØªØºÙŠÙŠØ± Ø¯Ø±Ø¬Ø© Ù…Ø¹ØªÙ…Ø¯Ø©** Ø¨Ø¯ÙˆÙ† ÙÙƒ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹ â€” ÙˆÙƒÙ„ ØªØºÙŠÙŠØ± Ù…ÙÙˆØ«Ù‘Ù‚.

```mermaid
graph LR
    U["Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"] -->|ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„| T["Trigger<br/>ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©"]
    T -->|Ù…Ø¹ØªÙ…Ø¯ ğŸ”’| BLOCK["âŒ Ø±ÙØ¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"]
    T -->|Ù…Ø³ÙˆØ¯Ø© âœï¸| ALLOW["âœ… Ø§Ù„Ø³Ù…Ø§Ø­ + ØªØ³Ø¬ÙŠÙ„"]
    ALLOW --> AUD["student_grade_audit<br/>Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚"]
```

---

## ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„

### 1ï¸âƒ£ Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (student_grade_audit)

| Ø§Ù„Ø­Ù‚Ù„ | Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ | Ø§Ù„Ù†ÙˆØ¹ | Ø§Ù„ÙˆØµÙ | Ù…Ø«Ø§Ù„ |
|-------|---------------|-------|-------|------|
| Ø§Ù„Ù…Ø¹Ø±Ù | `id` | BIGINT (PK) | Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ | 1 |
| Ø§Ù„Ø·Ø§Ù„Ø¨ | `enrollment_id` | INT (FK) | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ | 1 |
| Ø§Ù„Ù…Ø§Ø¯Ø© | `subject_id` | INT (FK) | Ø§Ù„Ù…Ø§Ø¯Ø© | 1 (Ø±ÙŠØ§Ø¶ÙŠØ§Øª) |
| Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ¯Ø± | `grade_table` | ENUM | Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠÙ‡ | monthly_grades |
| Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù‘Ù„ | `grade_field` | VARCHAR(50) | Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ | exam_score |
| Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© | `old_value` | DECIMAL(5,2) | Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ | 15.00 |
| Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© | `new_value` | DECIMAL(5,2) | Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ | 18.50 |
| Ø§Ù„Ù…Ø¹Ø¯Ù‘Ù„ | `changed_by_user_id` | INT (FK) | Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ | 5 |
| Ø§Ù„Ø³Ø¨Ø¨ | `change_reason` | TEXT | Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ | Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ØµØ¯ |
| Ø§Ù„ØªØ§Ø±ÙŠØ® | `changed_at` | TIMESTAMP | ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ | 2026-09-16 14:30 |

#### ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªØ±Ø´Ø§Ø¯ÙŠØ©
| id | enrollment_id | grade_table | grade_field | old | new | changed_by | reason |
|----|---------------|-------------|-------------|-----|-----|------------|--------|
| 1 | 1 | student_exam_scores | score | 15.00 | 18.50 | Ø£. Ø£Ø­Ù…Ø¯ | Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ØµØ¯ |
| 2 | 2 | monthly_grades | attendance_score | 3.00 | 4.50 | Ø§Ù„Ù†Ø¸Ø§Ù… | ØªØ­Ø¯ÙŠØ« Ø¢Ù„ÙŠ |
| 3 | 3 | monthly_grades | exam_score | 0.00 | 12.00 | Ø£. Ø£Ø­Ù…Ø¯ | Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙŠÙ„ |

---

## âš¡ Triggers (5 Ù…Ø­ÙÙ‘Ø²Ø§Øª)

### ğŸ” Triggers Ø§Ù„Ù‚ÙÙ„ (Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)

| # | Ø§Ù„Ø§Ø³Ù… | Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ù…ÙŠ | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|---|-------|---------------|---------|
| 1 | `trg_semester_grade_lock` | semester_grades | ÙŠÙ…Ù†Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ù†ØªÙŠØ¬Ø© ÙØµÙ„ **Ù…Ø¹ØªÙ…Ø¯Ø©** |
| 2 | `trg_annual_grade_lock` | annual_grades | ÙŠÙ…Ù†Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø³Ù†ÙˆÙŠØ© **Ù…Ø¹ØªÙ…Ø¯Ø©** |
| 3 | `trg_annual_result_lock` | annual_result | ÙŠÙ…Ù†Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© **Ù…Ø¹ØªÙ…Ø¯Ø©** |

**Ø§Ù„Ø³Ù„ÙˆÙƒ:** Ø¥Ø°Ø§ `grading_status_id = 3` (Ù…Ø¹ØªÙ…Ø¯) â†’ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±ÙÙˆØ¶ Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£.

### ğŸ“ Triggers Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª)

| # | Ø§Ù„Ø§Ø³Ù… | Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ | Ù…Ø§ ÙŠØ³Ø¬Ù‘Ù„Ù‡ |
|---|-------|----------------|-----------|
| 4 | `trg_exam_score_audit` | student_exam_scores | ØªØºÙŠÙŠØ± `score` |
| 5 | `trg_monthly_grade_audit` | monthly_grades | ØªØºÙŠÙŠØ± `exam_score` Ø£Ùˆ `attendance_score` |

---

## ğŸ’¡ Ø£Ù…Ø«Ù„Ø© SQL

### Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¹ÙŠÙ†
```sql
SELECT 
    sga.changed_at,
    sga.grade_table,
    sga.grade_field,
    sga.old_value,
    sga.new_value,
    u.full_name AS changed_by,
    sga.change_reason
FROM student_grade_audit sga
LEFT JOIN users u ON sga.changed_by_user_id = u.id
WHERE sga.enrollment_id = 1
ORDER BY sga.changed_at DESC;
```

### Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ (ØªÙ‚Ø±ÙŠØ± Ø±Ù‚Ø§Ø¨ÙŠ)
```sql
SELECT 
    grade_table,
    COUNT(*) AS total_changes,
    COUNT(DISTINCT enrollment_id) AS affected_students
FROM student_grade_audit
GROUP BY grade_table;
```

---

## ğŸ§© Ø¹Ù†Ø§ØµØ± ØªÙ‚Ù†ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù…ÙˆØ«Ù‚Ø©
- `grade_table` ÙÙŠ `student_grade_audit` ÙŠØ¯Ø¹Ù… Ø§Ù„Ù‚ÙŠÙ…:
  - `monthly_grades`
  - `semester_grades`
  - `annual_grades`
  - `student_exam_scores`
- Triggers Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© `@current_user_id` Ù„ØªØ¹Ø¨Ø¦Ø© `changed_by_user_id`.
- Triggers Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø© ØªØºÙŠÙŠØ± `grading_status_id` Ù…Ù† `3` (Ù…Ø¹ØªÙ…Ø¯) Ø¥Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø£Ø®Ø±Ù‰.

**ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«:** 2026-02-14
