# ๐ ุงูุงุฎุชุจุงุฑุงุช ูุงููุชุฑุงุช ุงูุงูุชุญุงููุฉ
## DDL_EXAMS v4.0 โ Enhanced Exam System

---

## ๐ ุจุทุงูุฉ ุงูููู
| ุงูุจูุฏ | ุงููููุฉ |
|-------|--------|
| **ุงูููู** | `DDL_EXAMS.sql` |
| **ุชุฑุชูุจ ุงูุชูููุฐ** | 2๏ธโฃ ุงูุซุงูู |
| **ุงูุฅุตุฏุงุฑ** | v4.0 |
| **ุงูููููุงุช** | 2 ุฌุฏูู + 1 View + 1 Procedure + 3 Trigger |
| **ูุนุชูุฏ ุนูู** | DDL_POLICIES, System 01 (users), System 02 (ุงูููุงุฉ), System 04 (ุงูุทูุงุจ), **System 08 (ุงูุฌุฏููุฉ)** |
| **ูุชูุงูู ูุน** | System 08 (ูุฌุงู ุงูุงูุชุญุงูุงุช) ุนุจุฑ `exam_timetable` |

---

## ๐ ุงูููุฏูุฉ
ูุธุงู ุงุฎุชุจุงุฑุงุช **ูุชูุงูู:** ุงูุฅุฏุงุฑุฉ ุชููุดุฆ ูุชุฑุฉ ุงูุชุญุงููุฉ โ ุงูุฌุฏููุฉ ุชุชู ูู **System 08 (exam_timetable)** โ ุงูู Trigger ูููุดุฆ ุณุฌูุงุช ููู ุงูุทูุงุจ ุขููุงู ููุง โ ุงููุนูู ูุนุฏูู ุงูุฏุฑุฌุงุช ููุท.

ุงูุงุฎุชุจุงุฑ ูุฑุชุจุท ุจุฌุฏูู `exam_timetable` ูู System 08ุ ุงูุฐู ูุญุฏุฏ ุงููุงุฏุฉ ูุงูุตู ูุงูุชุงุฑูุฎ ูุงูููุช.

```mermaid
graph LR
    A["๐ซ ุงูุฅุฏุงุฑุฉ"] -->|ุชูุดุฆ| EP["ูุชุฑุฉ ุงูุชุญุงููุฉ\n(DDL_EXAMS)"]
    EP -->|ุชุฌุฏูู| ET["exam_timetable\n(System 08)"]
    ET -->|Trigger ุขูู| SES["ุณุฌู ููู ุทุงูุจ ๐\n(student_exam_scores)"]
    T["๐จโ๐ซ ุงููุนูู"] -->|ูุนุฏูู| SES2["ุงูุฏุฑุฌุฉ + ุงูุญุถูุฑ"]
    SES2 --> V["v_exam_results_summary"]
```

---

## ๐ ุชูุงุตูู ุงูููููุงุช

### 1๏ธโฃ ุงููุชุฑุงุช ุงูุงูุชุญุงููุฉ (exam_periods)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงูุนุงู | `academic_year_id` | INT (FK) | ุงูุนุงู ุงูุฏุฑุงุณู |
| ุงููุตู | `semester_id` | INT (FK) | ุงููุตู ุงูุฏุฑุงุณู |
| ุงูุงุณู | `name_ar` | VARCHAR(100) | ุงุณู ุงููุชุฑุฉ |
| ุงูููุน | `exam_type_id` | TINYINT (FK) | **ุชู ุงูุชุญุฏูุซ (v4.0)** โ ุฑุงุจุท `lookup_exam_types` ูู System 08 |
| ุงูุจุฏุงูุฉ | `start_date` | DATE (**NOT NULL**) | ุชุงุฑูุฎ ุจุฏุงูุฉ ุงููุชุฑุฉ |
| ุงูููุงูุฉ | `end_date` | DATE (**NOT NULL**) | ุชุงุฑูุฎ ููุงูุฉ ุงููุชุฑุฉ |
| ุงูุญุงูุฉ | `status_id` | TINYINT (FK) | **ุฌุฏูุฏ** โ DRAFT, SCHEDULING, SCORING, APPROVED |
| ูุดุทุ | `is_active` | BOOLEAN | ูู ุงููุชุฑุฉ ูุนุงูุฉ |
| ููููุ | `is_locked` | BOOLEAN | ุญูููุฉ โ ูู ููููุฉ |

---

### 2๏ธโฃ ุฏุฑุฌุงุช ุงูุทูุงุจ (student_exam_scores)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงูุฌุฏูู | `exam_timetable_id` | INT (FK) | **ุชู ุงูุชุญุฏูุซ (v4.0)** โ ุฑุงุจุท ุฌุฏูู ุงูุงุฎุชุจุงุฑ ูู System 08 |
| ุงูุทุงูุจ | `enrollment_id` | INT (FK) | ุชุณุฌูู ุงูุทุงูุจ |
| ุงูุฏุฑุฌุฉ | `score` | DECIMAL(5,2) | ุงูุฏุฑุฌุฉ ุงููุญุตูุฉ |
| ุญุงุถุฑุ | `is_present` | BOOLEAN | ุญุถุฑ ุงูุงุฎุชุจุงุฑ |
| ููุน ุงูุบูุงุจ | `absence_type` | ENUM | `ุจุนุฐุฑ` / `ุจุฏูู_ุนุฐุฑ` |
| ุชูุงุตูู ุงูุนุฐุฑ | `excuse_details` | TEXT | ุณุจุจ ุงูุบูุงุจ |
| ููุงุญุธุงุช | `teacher_notes` | TEXT | ููุงุญุธุงุช ุงููุนูู |

> โก **ููุงุญุธุฉ:** ุฌุฏูู `exam_schedules` ุชู ูููู ุจุงููุงูู ุฅูู **System 08** ุจุงุณู `exam_timetable` ูุชูุญูุฏ ุงูุฌุฏููุฉ ูุงููุฌุงู.

---

### 3๏ธโฃ View: ููุฎุต ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ (v_exam_results_summary)

ูุนุฑุถ ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ ููู ุงุฎุชุจุงุฑ ุจุฌุฏูู `exam_timetable`:

| ุงูุญูู | ุงููุตู |
|-------|-------|
| `total_students` | ุนุฏุฏ ุงูุทูุงุจ ุงูููู |
| `present_count` / `absent_count` | ุนุฏุฏ ุงูุญุถูุฑ / ุงูุบูุงุจ |
| `excused_absent` / `unexcused_absent` | ุบูุงุจ ุจุนุฐุฑ / ุจุฏูู ุนุฐุฑ |
| `avg_score` / `avg_percentage` | ูุชูุณุท ุงูุฏุฑุฌุงุช / ุงููุณุจุฉ |
| `passed_count` / `failed_count` | ุนุฏุฏ ุงููุงุฌุญูู / ุงูุฑุงุณุจูู |

---

### 4๏ธโฃ Triggers

| ุงูู Trigger | ุงูุชูููุช | ุงููุธููุฉ |
|---|---|---|
| `trg_exam_score_validate_insert` | BEFORE INSERT | ูููุน `score > max_score` (ูุฌูุจ `max_score` ูู `exam_timetable`) + ูุตููุฑ ุงูุบุงุฆุจ |
| `trg_exam_score_validate_update` | BEFORE UPDATE | ููุณ ุงูุชุญูู ุนูุฏ ุงูุชุนุฏูู |

---

### 5๏ธโฃ Procedure ุฏุงุฎููุฉ ููุฑุตุฏ ุงูุขูู (`sp_populate_exam_scores`)

ูุฐุง ุงูุฅุฌุฑุงุก ููุฌูุฏ ุงูุขู ูู **System 08** (`DDL_SCHEDULING.sql`) ููููู ุจููุก ุฌุฏูู `student_exam_scores` ูู System 05 ุนูุฏ ุงุนุชูุงุฏ ุงูุฌุฏูู.

---

## ๐ก ุฃูุซูุฉ SQL

### ุณูุฑ ุงูุนูู ุงููุงูู (ุงูุฌุฏูุฏ v4.0)

```sql
-- 1๏ธโฃ ุงูุฅุฏุงุฑุฉ ุชูุดุฆ ูุชุฑุฉ ุงูุชุญุงููุฉ (System 05)
INSERT INTO exam_periods (academic_year_id, semester_id, name_ar, exam_type_id, status_id, start_date, end_date)
VALUES (1, 1, 'ุงุฎุชุจุงุฑ ุดูุฑ ูุญุฑู', 1, 1, '2026-09-15', '2026-09-17');
-- (1 = MONTHLY, 1 = DRAFT)

-- 2๏ธโฃ ุฌุฏููุฉ ุงุฎุชุจุงุฑ (System 08 - exam_timetable)
-- ูููู System 08 ุจููุก student_exam_scores ุชููุงุฆูุงู ุนุจุฑ SP

-- 3๏ธโฃ ุงููุนูู ูุนุฏูู ุงูุฏุฑุฌุงุช ุจุงูู UPDATE ููุท (System 05)
UPDATE student_exam_scores SET score = 18.50 
WHERE exam_timetable_id = 101 AND enrollment_id = 1;

-- 4๏ธโฃ ุชุณุฌูู ุบูุงุจ ุจุนุฐุฑ
UPDATE student_exam_scores 
SET is_present = FALSE, absence_type = 'ุจุนุฐุฑ', excuse_details = 'ูุฑูุถ โ ุชูุฑูุฑ ุทุจู'
WHERE exam_timetable_id = 101 AND enrollment_id = 3;
-- โฌ ุงูู Trigger ุณูุตููุฑ ุงูุฏุฑุฌุฉ ุขููุงู
```

---

## ๐งฉ ุนูุงุตุฑ ุชูููุฉ ุฅุถุงููุฉ ููุซูุฉ
- `exam_periods` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`, `locked_at`, `locked_by_user_id`.
- `student_exam_scores` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`, `updated_at`.

**ุชู ุงูุชุญุฏูุซ:** 2026-02-19 (v4.0)
