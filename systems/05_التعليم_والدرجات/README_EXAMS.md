# ๐ ุงูุงุฎุชุจุงุฑุงุช ูุงููุชุฑุงุช ุงูุงูุชุญุงููุฉ
## DDL_EXAMS v3.1 โ Enhanced Exam System

---

## ๐ ุจุทุงูุฉ ุงูููู
| ุงูุจูุฏ | ุงููููุฉ |
|-------|--------|
| **ุงูููู** | `DDL_EXAMS.sql` |
| **ุชุฑุชูุจ ุงูุชูููุฐ** | 2๏ธโฃ ุงูุซุงูู |
| **ุงูุฅุตุฏุงุฑ** | v3.2 |
| **ุงูููููุงุช** | 4 ุฌุฏูู + 1 View + 1 Procedure + 3 Trigger |
| **ูุนุชูุฏ ุนูู** | DDL_POLICIES, System 01 (users), System 02 (ุงูููุงุฉ), System 04 (ุงูุทูุงุจ) |
| **ูุชูุงูู ูุน** | System 08 (ูุฌุงู ุงูุงูุชุญุงูุงุช) ุนุจุฑ `exam_session_periods` |

---

## ๐ ุงูููุฏูุฉ
ูุธุงู ุงุฎุชุจุงุฑุงุช **ูุชูุงูู:** ุงูุฅุฏุงุฑุฉ ุชููุดุฆ ูุชุฑุฉ ุงูุชุญุงููุฉ โ ุชุฌุฏูู ุงุฎุชุจุงุฑ ููู ูุงุฏุฉ/ุตู โ ุงูู Trigger ูููุดุฆ ุณุฌูุงุช ููู ุงูุทูุงุจ ุขููุงู โ ุงููุนูู ูุนุฏูู ุงูุฏุฑุฌุงุช ููุท.

ุงูุงุฎุชุจุงุฑ ูุฑุชุจุท ุจู**ุงูุตู** (ุฃูู ุซุงููู) ูููุณ ุงูุดุนุจุฉ โ ุฃู **ููุญุฏ ููู ุงูุดุนุจ**.

```mermaid
graph LR
    A["๐ซ ุงูุฅุฏุงุฑุฉ"] -->|ุชูุดุฆ| EP["ูุชุฑุฉ ุงูุชุญุงููุฉ"]
    EP -->|ุชุฌุฏูู| ES["ุงุฎุชุจุงุฑ<br/>(ูุงุฏุฉ + ุตู)"]
    ES -->|Trigger ุขูู| SES["ุณุฌู ููู ุทุงูุจ ๐"]
    T["๐จโ๐ซ ุงููุนูู"] -->|ูุนุฏูู| SES2["ุงูุฏุฑุฌุฉ + ุงูุญุถูุฑ"]
    SES2 --> V["v_exam_results_summary"]
```

---

## ๐ ุชูุงุตูู ุงูููููุงุช

### 1๏ธโฃ ุงููุชุฑุงุช ุงูุงูุชุญุงููุฉ (exam_periods)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงูุนุงู | `academic_year_id` | INT (FK) | ุงูุนุงู ุงูุฏุฑุงุณู |
| ุงููุตู | `semester_id` | INT (FK) | ุงููุตู ุงูุฏุฑุงุณู |
| ุงูุงุณู | `name` | VARCHAR(100) | ุงุณู ุงููุชุฑุฉ |
| ุงูููุน | `type` | ENUM | MONTHLY, MIDTERM, FINAL, DIAGNOSTIC |
| ุงูุจุฏุงูุฉ | `start_date` | DATE (**NOT NULL**) | ุชุงุฑูุฎ ุงูุจุฏุงูุฉ |
| ุงูููุงูุฉ | `end_date` | DATE (**NOT NULL**) | ุชุงุฑูุฎ ุงูููุงูุฉ |
| ูุดุทุ | `is_active` | BOOLEAN | ูู ุงููุชุฑุฉ ูุนุงูุฉ |
| ุงูููุดุฆ | `created_by` | INT (FK โ users) | **ุฌุฏูุฏ** โ ูู ุฃูุดุฃ ุงููุชุฑุฉ |
| ููููุ | `is_locked` | BOOLEAN | ุญูููุฉ โ ูู ููููุฉ |

---

### 2๏ธโฃ ุฌุฏููุฉ ุงูุงุฎุชุจุงุฑุงุช (exam_schedules)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงููุชุฑุฉ | `exam_period_id` | INT (FK) | ุงููุชุฑุฉ ุงูุงูุชุญุงููุฉ |
| ุงููุงุฏุฉ | `subject_id` | INT (FK) | ุงููุงุฏุฉ |
| ุงูุตู | `grade_level_id` | INT (FK) | ุงูุตู (ููุญุฏ ููู ุงูุดุนุจ) |
| ุงูุชุงุฑูุฎ | `exam_date` | DATE | ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ |
| ุงูููุช | `start_time` | TIME (NULL) | **ุฌุฏูุฏ** โ ููุช ุจุฏุงูุฉ ุงูุงุฎุชุจุงุฑ |
| ุงููุฏุฉ | `duration_minutes` | SMALLINT (NULL) | **ุฌุฏูุฏ** โ ูุฏุฉ ุงูุงุฎุชุจุงุฑ ุจุงูุฏูุงุฆู |
| ุงูุนุธูู | `max_score` | DECIMAL(5,2) | ุงูุฏุฑุฌุฉ ุงูุนุธูู |
| ุงูููุดุฆ | `created_by` | INT (FK โ users) | **ุฌุฏูุฏ** โ ูู ุฌุฏูู ุงูุงุฎุชุจุงุฑ |

> โก ุนูุฏ ุฅูุดุงุก ุฌุฏูู ุงุฎุชุจุงุฑุ ุงูู Trigger `trg_exam_schedule_auto_populate` ูููุดุฆ ุณุฌูุงุช ููู ุทุงูุจ ูุดุท ูู **ูู ุดุนุจ ุงูุตู** ุขููุงู

---

### 3๏ธโฃ ุฏุฑุฌุงุช ุงูุทูุงุจ (student_exam_scores)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงูุงุฎุชุจุงุฑ | `exam_schedule_id` | INT (FK) | ุฌุฏูู ุงูุงุฎุชุจุงุฑ |
| ุงูุทุงูุจ | `enrollment_id` | INT (FK) | ุชุณุฌูู ุงูุทุงูุจ |
| ุงูุฏุฑุฌุฉ | `score` | DECIMAL(5,2) | ุงูุฏุฑุฌุฉ ุงููุญุตูุฉ |
| ุญุงุถุฑุ | `is_present` | BOOLEAN | ุญุถุฑ ุงูุงุฎุชุจุงุฑ |
| ููุน ุงูุบูุงุจ | `absence_type` | ENUM | **ุฌุฏูุฏ** โ `ุจุนุฐุฑ` / `ุจุฏูู_ุนุฐุฑ` |
| ุชูุงุตูู ุงูุนุฐุฑ | `excuse_details` | TEXT | ุณุจุจ ุงูุบูุงุจ |
| ููุงุญุธุงุช | `teacher_notes` | TEXT | ููุงุญุธุงุช ุงููุนูู |

---

### 4๏ธโฃ View: ููุฎุต ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ (v_exam_results_summary) โ ุฌุฏูุฏ

| ุงูุญูู | ุงููุตู |
|-------|-------|
| `total_students` | ุนุฏุฏ ุงูุทูุงุจ ุงูููู |
| `present_count` / `absent_count` | ุนุฏุฏ ุงูุญุถูุฑ / ุงูุบูุงุจ |
| `excused_absent` / `unexcused_absent` | ุบูุงุจ ุจุนุฐุฑ / ุจุฏูู ุนุฐุฑ |
| `avg_score` / `avg_percentage` | ูุชูุณุท ุงูุฏุฑุฌุงุช / ุงููุณุจุฉ |
| `passed_count` / `failed_count` | ุนุฏุฏ ุงููุงุฌุญูู / ุงูุฑุงุณุจูู |

---

### 5๏ธโฃ Triggers

| ุงูู Trigger | ุงูุชูููุช | ุงููุธููุฉ |
|---|---|---|
| `trg_exam_schedule_auto_populate` | AFTER INSERT ON exam_schedules | ูููุดุฆ ุณุฌูุงุช ููู ุทุงูุจ ูุดุท ูู ุงูุตู |
| `trg_exam_score_validate_insert` | BEFORE INSERT ON student_exam_scores | ูููุน `score > max_score` + ูุตููุฑ ุฏุฑุฌุฉ ุงูุบุงุฆุจ |
| `trg_exam_score_validate_update` | BEFORE UPDATE ON student_exam_scores | ููุณ ุงูุชุญูู ุนูุฏ ุงูุชุนุฏูู |

---

### 6๏ธโฃ Procedure ุฏุงุฎููุฉ ููุฑุตุฏ ุงูุขูู (`sp_populate_exam_scores`)

ูุฐุง ุงูุฅุฌุฑุงุก ููุฌูุฏ ูู SQL ููุชู ุงุณุชุฏุนุงุคู ุชููุงุฆูุงู ูู `trg_exam_schedule_auto_populate`:
- ููุฑุฃ `grade_level_id` ูู `exam_schedules`
- ููุดุฆ ุณุฌูุงุช ุงูุชุฑุงุถูุฉ ูู `student_exam_scores` ููู ุทุงูุจ ูุดุท ูู ุฌููุน ุดุนุจ ููุณ ุงูุตู
- ูุณุชุฎุฏู `INSERT IGNORE` ูุชุฌูุจ ุงูุชูุฑุงุฑ ุนูุฏ ุฅุนุงุฏุฉ ุงูุงุณุชุฏุนุงุก

```sql
CALL sp_populate_exam_scores(1);  -- exam_schedule_id
```

---

## ๐ก ุฃูุซูุฉ SQL

### ุณูุฑ ุงูุนูู ุงููุงูู (ุงูุฌุฏูุฏ)
```sql
-- 1๏ธโฃ ุงูุฅุฏุงุฑุฉ ุชูุดุฆ ูุชุฑุฉ ุงูุชุญุงููุฉ
INSERT INTO exam_periods (academic_year_id, semester_id, name, type, 
    start_date, end_date, created_by)
VALUES (1, 1, 'ุงุฎุชุจุงุฑ ุดูุฑ ูุญุฑู', 'MONTHLY', '2026-09-15', '2026-09-17', 1);

-- 2๏ธโฃ ุฌุฏููุฉ ุงุฎุชุจุงุฑ โ ุงูู Trigger ูุฑุตุฏ ุงูุทูุงุจ ุขููุงู
INSERT INTO exam_schedules (exam_period_id, subject_id, grade_level_id, 
    exam_date, max_score, start_time, duration_minutes, created_by)
VALUES (1, 1, 1, '2026-09-15', 20.00, '08:00', 90, 1);

-- 3๏ธโฃ ุงููุนูู ูุนุฏูู ุงูุฏุฑุฌุงุช ุจุงูู UPDATE ููุท
UPDATE student_exam_scores SET score = 18.50 
WHERE exam_schedule_id = 1 AND enrollment_id = 1;

-- 4๏ธโฃ ุชุณุฌูู ุบูุงุจ ุจุนุฐุฑ
UPDATE student_exam_scores 
SET is_present = FALSE, absence_type = 'ุจุนุฐุฑ', excuse_details = 'ูุฑูุถ โ ุชูุฑูุฑ ุทุจู'
WHERE exam_schedule_id = 1 AND enrollment_id = 3;
-- โฌ ุงูู Trigger ุณูุตููุฑ ุงูุฏุฑุฌุฉ ุขููุงู

-- 5๏ธโฃ ููุฎุต ุงููุชุงุฆุฌ
SELECT * FROM v_exam_results_summary WHERE exam_schedule_id = 1;
```

### ุณุญุจ ุฏุฑุฌุฉ ุงูููุงุฆู ุฅูู semester_grades
```sql
-- ุจุนุฏ ุฑุตุฏ ุฏุฑุฌุงุช ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู (type = 'FINAL'):
CALL sp_fill_final_exam_score(1, 1);  -- ูุตู ุฃููุ ุดุนุจุฉ 1
```

---

### 7๏ธโฃ ๐ ุฑุจุท ุงููุชุฑุงุช ุจุฌูุณุงุช ุงููุฌุงู (exam_session_periods)

ุฌุฏูู ูุณูุท ูุฑุจุท ุงููุชุฑุฉ ุงูุงูุชุญุงููุฉ **ุงูุฃูุงุฏูููุฉ** (System 05) ุจุงูุฌูุณุฉ **ุงูููุฌุณุชูุฉ** (System 08):
- **System 05** = ุงูุฏุฑุฌุงุช ูุงููุชุงุฆุฌ (ุงุฎุชุจุงุฑ ุดูุฑ ูุญุฑูุ ุฏุฑุฌุฉ 20)
- **System 08** = ุงูุชูุธูู ุงููุงุฏู (ูุฌูุฉ 1ุ ููุนุฏ 5ุ ุฑูู ุฌููุณ 123)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุฌูุณุฉ ุงูุงูุชุญุงู | `exam_session_id` | INT (FK) | ุฌูุณุฉ ูุฌุงู ุงูุงูุชุญุงูุงุช (System 08) |
| ุงููุชุฑุฉ ุงูุงูุชุญุงููุฉ | `exam_period_id` | INT (FK) | ุงููุชุฑุฉ ุงูุฃูุงุฏูููุฉ (System 05) |
| ููุงุญุธุงุช | `notes` | TEXT | ููุงุญุธุงุช ุงุฎุชูุงุฑูุฉ |
| ุงูููุดุฆ | `created_by` | INT (FK โ users) | ุงููุณุชุฎุฏู ุงูุฐู ุฃูุดุฃ ุงูุฑุจุท |

#### ๐ ุจูุงูุงุช ุงุณุชุฑุดุงุฏูุฉ
| id | exam_session_id | exam_period_id | notes |
|----|-----------------|----------------|-------|
| 1 | 1 (ุงุฎุชุจุงุฑุงุช ููุงูุฉ ุงููุตู ุงูุฃูู) | 4 (ูุชุฑุฉ ููุงูุฉ ุงููุตู ุงูุฃูู) | ุฑุจุท ุงูููุงุฆู ุจุงููุฌุงู |
| 2 | 4 (ุงุฎุชุจุงุฑุงุช ุดูุฑ ูุญุฑู ุงููุตููุฉ) | 1 (ุงุฎุชุจุงุฑ ุดูุฑ ูุญุฑู) | ุฑุจุท ุงูุดูุฑู ุจุงููุฌุงู |

```mermaid
graph LR
    EP["exam_periods\n(System 05)\nุงูุฌุงูุจ ุงูุฃูุงุฏููู"] <-->|exam_session_periods| ES["exam_sessions\n(System 08)\nุงูุฌุงูุจ ุงูููุฌุณุชู"]
    
    style EP fill:#1565c0,color:#fff
    style ES fill:#7b1fa2,color:#fff
```

### ุฌูุจ ุงููุชุฑุฉ ุงูุฃูุงุฏูููุฉ ูุน ุจูุงูุงุช ุงููุฌุงู
```sql
SELECT 
    ep.name AS period_name,
    ep.type,
    es.exam_name AS session_name,
    es.exam_type,
    COUNT(ea.id) AS assigned_students
FROM exam_session_periods esp
JOIN exam_periods ep ON esp.exam_period_id = ep.id
JOIN exam_sessions es ON esp.exam_session_id = es.id
LEFT JOIN exam_assignments ea ON es.id = ea.exam_session_id
GROUP BY esp.id;
```

---

## ๐งฉ ุนูุงุตุฑ ุชูููุฉ ุฅุถุงููุฉ ููุซูุฉ
- `exam_periods` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`, `locked_at`, `locked_by_user_id`.
- `exam_schedules` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`.
- `student_exam_scores` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`, `updated_at`.
- `exam_session_periods` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`.

**ุชู ุงูุชุญุฏูุซ:** 2026-02-14
