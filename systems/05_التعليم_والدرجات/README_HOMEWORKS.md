# ๐ ุงููุงุฌุจุงุช ุงูููุฒููุฉ
## DDL_HOMEWORKS v3.1 โ Enhanced Homework System

---

## ๐ ุจุทุงูุฉ ุงูููู
| ุงูุจูุฏ | ุงููููุฉ |
|-------|--------|
| **ุงูููู** | `DDL_HOMEWORKS.sql` |
| **ุชุฑุชูุจ ุงูุชูููุฐ** | 3๏ธโฃ ุงูุซุงูุซ |
| **ุงูุฅุตุฏุงุฑ** | v3.1 |
| **ุงูููููุงุช** | 1 Lookup + 2 ุฌุฏูู + 2 View + 1 Procedure + 2 Trigger |
| **ูุนุชูุฏ ุนูู** | System 01 (users), System 02 (ุงูููุงุฉ), System 04 (ุงูุทูุงุจ) |

---

## ๐ ุงูููุฏูุฉ
ูุธุงู ูุงุฌุจุงุช **ูุชูุงูู:** ุงููุณุชุฎุฏู ูููุดุฆ ูุงุฌุจ ูุฑุชุจุท ุจู**ุงููุงุฏุฉ + ุงููุตู**ุ ุซู ุงูู Trigger ูููุดุฆ ุณุฌูุงุช ููู ุงูุทูุงุจ ุขููุงู. ุงููุนูู ูุนุฏูู ุญุงูุฉ ูู ุทุงูุจ (ูููุฐ/ูู ููููุฐ). ูุฏุนู ุฃููุงุน ูุงุฌุจุงุช ูุชุนุฏุฏุฉุ ุชุงุฑูุฎ ุชุณูููุ ูุญุฐู ูุงุนู.

```mermaid
graph LR
    U["ุงููุณุชุฎุฏู"] -->|ููุดุฆ| HW["ูุงุฌุจ<br/>(ูุงุฏุฉ + ูุตู + ููุน)"]
    HW -->|Trigger ุขูู| SHW["ุฑุตุฏ ููู ุทุงูุจ ๐"]
    U -->|ูุนุฏูู| SHW2["ูููุฐ โ / ูู ููููุฐ โ"]
    SHW2 -->|ุงุฎุชูุงุฑู| MG["ุฏุฑุฌุฉ ูุฏููุฉ โ๏ธ"]
    SHW2 --> V["v_homework_effective_grade"]
    V --> VS["v_homework_summary"]
```

### ๐งฎ ูุนุงุฏูุฉ ุงูุฏุฑุฌุฉ
```
ุฅุฐุง ุงููุนูู ุฃุฏุฎู ุฏุฑุฌุฉ ูุฏููุฉ โ ูุณุชุฎุฏููุง
ูุฅูุง ุฅุฐุง ูููุฐ               โ ุงูุฏุฑุฌุฉ = max_grade (ูุงููุฉ)
ูุฅูุง                         โ ุงูุฏุฑุฌุฉ = 0
```

---

## ๐ ุชูุงุตูู ุงูููููุงุช

### 0๏ธโฃ ุฃููุงุน ุงููุงุฌุจุงุช (lookup_homework_types)

| id | name_ar |
|----|---------|
| 1 | ูุงุฌุจ ููุฒูู |
| 2 | ุจุญุซ |
| 3 | ูุดุฑูุน |
| 4 | ุชูุฑูุฑ |
| 5 | ูุดุงุท ุตูู |
| 6 | ุฃุฎุฑู |

---

### 1๏ธโฃ ุชุนุฑูู ุงููุงุฌุจุงุช (homeworks)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงูุนุงู | `academic_year_id` | INT (FK) | ุงูุนุงู ุงูุฏุฑุงุณู |
| ุงููุตู | `semester_id` | INT (FK) | ุงููุตู ุงูุฏุฑุงุณู |
| ุงูุดูุฑ | `month_id` | INT (FK) | ุงูุดูุฑ ุงูุฃูุงุฏููู (**NOT NULL**) |
| ุงูููุดุฆ | `created_by` | INT (FK โ users) | **ุงููุณุชุฎุฏู** ุงูุฐู ุฃูุดุฃ ุงููุงุฌุจ |
| ุงูุดุนุจุฉ | `classroom_id` | INT (FK) | ุงููุตู/ุงูุดุนุจุฉ |
| ุงููุงุฏุฉ | `subject_id` | INT (FK) | ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ |
| ุงูููุน | `homework_type_id` | TINYINT (FK) | ููุน ุงููุงุฌุจ (ุงูุชุฑุงุถู: ูุงุฌุจ ููุฒูู) |
| ุชุงุฑูุฎ ุงูุฅุนุทุงุก | `homework_date` | DATE | ุชุงุฑูุฎ ุฅุนุทุงุก ุงููุงุฌุจ |
| ุชุงุฑูุฎ ุงูุชุณููู | `due_date` | DATE (NULL) | ุชุงุฑูุฎ ุงูุชุณููู ุงููุทููุจ |
| ุงูุนููุงู | `title` | VARCHAR(200) | ุนููุงู ุงููุงุฌุจ |
| ุงููุญุชูู | `content` | TEXT | ุชูุงุตูู (ุงุฎุชูุงุฑู) |
| ุงูุฏุฑุฌุฉ ุงูุนุธูู | `max_grade` | DECIMAL(4,1) | ุงูุฏุฑุฌุฉ ุงููุณุชุญูุฉ (ุงูุชุฑุงุถู 5.0) |
| ูุดุท | `is_active` | BOOLEAN | ุญุฐู ูุงุนู (TRUE = ูุดุท) |

---

### 2๏ธโฃ ุฑุตุฏ ุงููุงุฌุจุงุช (student_homeworks)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู |
|-------|---------------|-------|-------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ |
| ุงููุงุฌุจ | `homework_id` | INT (FK) | ูุฑุฌุน ูููุงุฌุจ |
| ุงูุทุงูุจ | `enrollment_id` | INT (FK) | ูุฑุฌุน ูุชุณุฌูู ุงูุทุงูุจ |
| ูููุฐุ | `is_completed` | BOOLEAN | ูููุฐ / ูู ููููุฐ |
| ููุช ุงูุชุณููู | `submitted_at` | TIMESTAMP (NULL) | **ุฌุฏูุฏ** โ ููููุฃ ุขููุงู ุนูุฏ is_completed = TRUE |
| ุฏุฑุฌุฉ ูุฏููุฉ | `manual_grade` | DECIMAL(4,1) | ุงุฎุชูุงุฑูุฉ โ NULL = ุขูู |
| ููุงุญุธุงุช | `notes` | VARCHAR(255) | ููุงุญุธุฉ ูุฎุชุตุฑุฉ |

> โก ูุชู ุฅูุดุงุก ุณุฌูุงุช ุงูุทูุงุจ **ุขููุงู** ุจูุงุณุทุฉ `trg_homework_auto_populate` ุนูุฏ ุฅูุดุงุก ูุงุฌุจ ุฌุฏูุฏ

---

### 3๏ธโฃ View: ุงูุฏุฑุฌุฉ ุงููุนููุฉ (v_homework_effective_grade)

| ุงูุญูู | ุงููุตู |
|-------|-------|
| `homework_id` | ุงููุงุฌุจ |
| `enrollment_id` | ุงูุทุงูุจ |
| `subject_id` | ุงููุงุฏุฉ |
| `month_id` | ุงูุดูุฑ |
| `is_completed` | ูููุฐุ |
| `submitted_at` | ููุช ุงูุชุณููู |
| `due_date` | ุชุงุฑูุฎ ุงูุชุณููู ุงููุทููุจ |
| `is_late` | **ุฌุฏูุฏ** โ ูู ุงูุชุณููู ูุชุฃุฎุฑุ |
| `effective_grade` | ุงูุฏุฑุฌุฉ ุงููุนููุฉ |

---

### 4๏ธโฃ View: ููุฎุต ุงููุงุฌุจ (v_homework_summary) โ ุฌุฏูุฏ

| ุงูุญูู | ุงููุตู |
|-------|-------|
| `homework_id` | ุงููุงุฌุจ |
| `total_students` | ุนุฏุฏ ุงูุทูุงุจ ุงูููู |
| `completed_count` | ุนุฏุฏ ุงููููุฐูู |
| `not_completed_count` | ุนุฏุฏ ุบูุฑ ุงููููุฐูู |
| `completion_rate` | ูุณุจุฉ ุงูุชูููุฐ % |
| `avg_grade` | ูุชูุณุท ุงูุฏุฑุฌุงุช |

---

### 5๏ธโฃ Triggers

| ุงูู Trigger | ุงูุชูููุช | ุงููุธููุฉ |
|---|---|---|
| `trg_homework_auto_populate` | AFTER INSERT ON homeworks | ูููุดุฆ ุณุฌูุงุช `student_homeworks` ููู ุทุงูุจ ูุดุท ูู ุงููุตู |
| `trg_homework_submitted_at` | BEFORE UPDATE ON student_homeworks | ููุนููู `submitted_at` ุขููุงู ุนูุฏ `is_completed = TRUE` ููุนูุฏู `NULL` ุนูุฏ ุฅุฑุฌุงุน ุงูุญุงูุฉ ุฅูู `FALSE` |

---

### 6๏ธโฃ Procedure ุฏุงุฎููุฉ ููุฑุตุฏ ุงูุขูู (`sp_populate_student_homeworks`)

ูุฐุง ุงูุฅุฌุฑุงุก ููุฌูุฏ ูู SQL ููุชู ุงุณุชุฏุนุงุคู ุชููุงุฆูุงู ูู `trg_homework_auto_populate`:
- ููุฑุฃ `classroom_id` ูู `homeworks`
- ููุดุฆ ุณุฌูุงู ููู ุทุงูุจ ูุดุท ูู ููุณ ุงููุตู ุฏุงุฎู `student_homeworks`
- ูุณุชุฎุฏู `INSERT IGNORE` ูุชุฌูุจ ุงูุชูุฑุงุฑ

```sql
CALL sp_populate_student_homeworks(1);  -- homework_id
```

---

## ๐ก ุฃูุซูุฉ SQL

### ุณูุฑ ุงูุนูู ุงููุงูู (ุงูุฌุฏูุฏ)
```sql
-- 1๏ธโฃ ุงููุณุชุฎุฏู ููุดุฆ ูุงุฌุจ โ ุงูู Trigger ูุฑุตุฏ ุงูุทูุงุจ ุขููุงู
INSERT INTO homeworks (academic_year_id, semester_id, month_id, created_by, 
    classroom_id, subject_id, title, max_grade, due_date, homework_type_id)
VALUES (1, 1, 1, 1, 1, 1, 'ุญู ุชูุงุฑูู ุงูุจุงุจ ุงูุฃูู', 5.0, '2026-09-21', 1);

-- 2๏ธโฃ ุงููุนูู ูุนุฏูู ุญุงูุฉ ุงูุทูุงุจ (ุงูุงูุชุฑุงุถู: ูู ููููุฐ)
UPDATE student_homeworks SET is_completed = TRUE 
WHERE homework_id = 1 AND enrollment_id = 1;
-- โฌ submitted_at ููููุฃ ุขููุงู ุจุงูู Trigger

-- 3๏ธโฃ ุงูุชุญูู ูู ุงูุฏุฑุฌุงุช
SELECT enrollment_id, effective_grade, is_late 
FROM v_homework_effective_grade WHERE homework_id = 1;

-- 4๏ธโฃ ููุฎุต ุงููุงุฌุจ
SELECT * FROM v_homework_summary WHERE homework_id = 1;
```

### ุงููุงุฌุจุงุช ุงููุชุฃุฎุฑุฉ
```sql
SELECT enrollment_id, effective_grade, submitted_at, due_date
FROM v_homework_effective_grade 
WHERE is_late = TRUE AND month_id = 1;
```

### ุญุฐู ูุงุนู
```sql
UPDATE homeworks SET is_active = FALSE WHERE id = 1;
-- ุงููุงุฌุจ ูู ูุธูุฑ ูู v_homework_effective_grade ููุง v_homework_summary
```

---

## ๐งฉ ุนูุงุตุฑ ุชูููุฉ ุฅุถุงููุฉ ููุซูุฉ
- `homeworks` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`, `updated_at`.
- `student_homeworks` ูุญุชูู ุฃูุถุงู ุนูู: `created_at`, `updated_at`.
- ููุฌุฏ ููุฏ ูุฑูุฏ `uk_student_homework` ูููุน ุชูุฑุงุฑ ููุณ ุงูุทุงูุจ ูููุณ ุงููุงุฌุจ.

**ุชู ุงูุชุญุฏูุซ:** 2026-02-14
