# نتائج الفصل والعام (Subsystem 05)
## `DDL_RESULTS.sql`

هذا النظام الفرعي هو محرك النتيجة النهائية: يحسب نتيجة الفصل، ثم نتيجة العام، ثم القرار والترتيب.

## شرح مبسط
- كل مادة لها نتيجة فصل أول وثان.
- النظام يجمع الفصلين إلى نتيجة سنوية للمادة.
- ثم يحسب النتيجة الشاملة للطالب: مجموع، نسبة، ترتيب، قرار.
- القرار النهائي يعتمد على قواعد قابلة للتخصيص لكل صف.

## الجداول الأساسية

| الجدول | وظيفته |
|---|---|
| `semester_grades` | نتيجة المادة في الفصل |
| `annual_grades` | نتيجة المادة السنوية |
| `annual_result` | النتيجة الشاملة للطالب |
| `lookup_annual_statuses` | حالات المادة السنوية (ناجح/راسب/...) |
| `lookup_promotion_decisions` | قرارات النقل (ينقل/يعيد/مشروط/...) |
| `grading_outcome_rules` | قواعد القرار وكسر التعادل لكل عام/صف |

## الإجراءات الأساسية

| الإجراء | وظيفته |
|---|---|
| `sp_calculate_semester_totals` | يحسب أعمال الفصل من المحصلة الشهرية |
| `sp_fill_final_exam_score` | يجلب درجة النهائي من الاختبارات النهائية |
| `sp_calculate_annual_results` | يحسب السنوي + القرار + الترتيب |

## شرح الجداول والأعمدة

### 1) `semester_grades`
| العمود | الترجمة | الهدف |
|---|---|---|
| `enrollment_id` | الطالب المقيد | صاحب النتيجة |
| `subject_id` | المادة | مادة النتيجة |
| `semester_id` | الفصل | أول/ثان |
| `semester_work_total` | أعمال الفصل | مجموع الأشهر |
| `final_exam_score` | درجة النهائي | نتيجة اختبار نهائي |
| `semester_total` | إجمالي الفصل | أعمال + نهائي |
| `grading_status_id` | حالة الاعتماد | مسودة/مراجعة/معتمد |

### 2) `annual_grades`
| العمود | الترجمة | الهدف |
|---|---|---|
| `semester1_total` | نتيجة الفصل الأول | جزء 1 من النتيجة السنوية |
| `semester2_total` | نتيجة الفصل الثاني | جزء 2 من النتيجة السنوية |
| `annual_total` | مجموع المادة السنوي | ناتج الفصلين |
| `annual_percentage` | نسبة المادة السنوية | مقارنة بحد النجاح |
| `final_status_id` | حالة المادة | ناجح/راسب/مكمل/محروم |

### 3) `annual_result`
| العمود | الترجمة | الهدف |
|---|---|---|
| `total_all_subjects` | مجموع كل المواد | مجموع الطالب النهائي |
| `max_possible_total` | الدرجة العظمى الكلية | مرجع النسبة |
| `percentage` | النسبة النهائية | المؤشر العام للطالب |
| `rank_in_class` | الترتيب في الشعبة | مقارنة بزملاء الشعبة |
| `rank_in_grade` | الترتيب على الصف | مقارنة بجميع الشعب |
| `passed_subjects_count` | عدد المواد الناجحة | تحديد القرار |
| `failed_subjects_count` | عدد المواد الراسبة | تحديد القرار |
| `promotion_decision_id` | قرار النقل | ينقل/مشروط/يعيد |

### 4) `grading_outcome_rules`
| العمود | الترجمة | الهدف |
|---|---|---|
| `promoted_max_failed_subjects` | حد الرسوب للنجاح المباشر | مثال: 0 |
| `conditional_max_failed_subjects` | حد الرسوب للنقل المشروط | مثال: 2 |
| `conditional_decision_id` | قرار الحالة الشرطية | غالبًا: مشروط |
| `retained_decision_id` | قرار الرسوب | غالبًا: يعيد السنة |
| `tie_break_strategy` | سياسة كسر التعادل | نسبة فقط أو نسبة ثم مجموع أو نسبة ثم اسم |

## سير العملية
1. تجميع المحصلات الشهرية داخل نتيجة الفصل.
2. إضافة درجة النهائي للفصل.
3. بناء نتائج المواد السنوية.
4. احتساب النتيجة الشاملة والقرار.
5. تطبيق الترتيب داخل الشعبة ثم على مستوى الصف.

## سجلات توضيحية

### عينة 10 نتائج شاملة (`annual_result`)
| id | enrollment_id | academic_year_id | total_all_subjects | max_possible_total | percentage | rank_in_class | rank_in_grade | passed_subjects_count | failed_subjects_count | promotion_decision_id |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 1 | 5001 | 1 | 515 | 600 | 85.83 | 1 | 3 | 7 | 0 | 1 |
| 2 | 5002 | 1 | 502 | 600 | 83.67 | 2 | 5 | 7 | 0 | 1 |
| 3 | 5003 | 1 | 471 | 600 | 78.50 | 3 | 11 | 6 | 1 | 4 |
| 4 | 5004 | 1 | 525 | 600 | 87.50 | 1 | 2 | 7 | 0 | 1 |
| 5 | 5005 | 1 | 498 | 600 | 83.00 | 2 | 6 | 7 | 0 | 1 |
| 6 | 5006 | 1 | 460 | 600 | 76.67 | 3 | 13 | 6 | 1 | 4 |
| 7 | 5007 | 1 | 430 | 600 | 71.67 | 4 | 18 | 5 | 2 | 4 |
| 8 | 5008 | 1 | 535 | 600 | 89.17 | 1 | 1 | 7 | 0 | 1 |
| 9 | 5009 | 1 | 489 | 600 | 81.50 | 2 | 8 | 7 | 0 | 1 |
| 10 | 5010 | 1 | 420 | 600 | 70.00 | 4 | 20 | 5 | 2 | 2 |

### عينة قواعد قرار (`grading_outcome_rules`)
| id | academic_year_id | grade_level_id | promoted_max_failed_subjects | conditional_max_failed_subjects | conditional_decision_id | retained_decision_id | tie_break_strategy | is_active |
|---|---:|---:|---:|---:|---:|---:|---|---:|
| 1 | 1 | 7 | 0 | 2 | 4 | 2 | PERCENTAGE_THEN_NAME | 1 |
| 2 | 1 | 8 | 0 | 2 | 4 | 2 | PERCENTAGE_THEN_NAME | 1 |
| 3 | 1 | 9 | 0 | 2 | 4 | 2 | PERCENTAGE_THEN_TOTAL | 1 |
| 4 | 1 | 10 | 0 | 1 | 4 | 2 | PERCENTAGE_ONLY | 1 |
| 5 | 1 | 11 | 0 | 1 | 4 | 2 | PERCENTAGE_ONLY | 1 |
| 6 | 1 | 12 | 0 | 1 | 4 | 2 | PERCENTAGE_THEN_TOTAL | 1 |

### قرارات النقل (`lookup_promotion_decisions`)
| id | name_ar | code |
|---|---|---|
| 1 | ينقل للصف التالي | PROMOTED |
| 2 | يعيد السنة | RETAINED |
| 3 | يُفصل | DISMISSED |
| 4 | ينقل بشروط (مكمل) | CONDITIONAL |
