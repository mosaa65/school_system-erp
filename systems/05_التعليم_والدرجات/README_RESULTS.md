# ๐ ุงููุชุงุฆุฌ โ ุงููุตู + ุงูุนุงู + ูุฑุงุฑ ุงูููู
## DDL_RESULTS โ Semester, Annual & Promotion Decisions

---

## ๐ ุจุทุงูุฉ ุงูููู
| ุงูุจูุฏ | ุงููููุฉ |
|-------|--------|
| **ุงูููู** | `DDL_RESULTS.sql` |
| **ุชุฑุชูุจ ุงูุชูููุฐ** | 5๏ธโฃ ุงูุฎุงูุณ |
| **ุนุฏุฏ ุงูุนูุงุตุฑ** | 5 ุฌุฏุงูู + 1 View + 3 Stored Procedures |
| **ูุนุชูุฏ ุนูู** | DDL_POLICIES, DDL_MONTHLY, System 02 (ุงูููุงุฉ) |
| **๐ ุฌุฏูุฏ** | `annual_grades` + `annual_result` + `lookup_promotion_decisions` |

---

## ๐ ุงูููุฏูุฉ
ูุฐุง ุฃูู ููู ูู ุงููุธุงู โ ูุญุชูู ุนูู ุงููุณุงุฑ ุงููุงูู ูู **ูุชูุฌุฉ ุงููุตู** ุฅูู **ูุชูุฌุฉ ุงูุนุงู** ุฅูู **ูุฑุงุฑ ุงูููู**. ูุชุถูู ุฌุฏูููู ุฌุฏูุฏูู ูููุงู ูู ููููุง ูู ุงููุณุฎุฉ ุงูุณุงุจูุฉ.

```mermaid
graph TD
    MG["monthly_grades<br/>ุงููุญุตูุงุช ุงูุดูุฑูุฉ"] -->|sp_calculate_semester_totals| SG["semester_grades<br/>ูุชูุฌุฉ ุงููุตู"]
    SG -->|sp_calculate_annual_results| AG["annual_grades ๐<br/>ูุชูุฌุฉ ุงูุนุงู ููู ูุงุฏุฉ"]
    AG --> AR["annual_result ๐<br/>ุงููุชูุฌุฉ ุงูุดุงููุฉ + ูุฑุงุฑ ุงูููู"]
    AR --> CERT["System 17<br/>ุงูุดูุงุฏุงุช"]
    
    style AG fill:#2e7d32,color:#fff
    style AR fill:#2e7d32,color:#fff
```

---

## ๐ ุชูุงุตูู ุงูุฌุฏุงูู

### 1๏ธโฃ ูุชูุฌุฉ ุงููุตู (semester_grades)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู | ูุซุงู |
|-------|---------------|-------|-------|------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ | 1 |
| ุงูุทุงูุจ | `enrollment_id` | INT (FK) | ุชุณุฌูู ุงูุทุงูุจ | 1 |
| ุงููุงุฏุฉ | `subject_id` | INT (FK) | ุงููุงุฏุฉ | 1 (ุฑูุงุถูุงุช) |
| ุงููุตู | `semester_id` | INT (FK) | ุงููุตู ุงูุฏุฑุงุณู | 1 (ุงูุฃูู) |
| ุฃุนูุงู ุงููุตู | `semester_work_total` | DECIMAL(5,2) | ูุฌููุน ุงููุญุตูุงุช ุงูุดูุฑูุฉ | 32.80 |
| ุงูููุงุฆู | `final_exam_score` | DECIMAL(5,2) | ุฏุฑุฌุฉ ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู | 38.00 |
| ุงูุฅุฌูุงูู | `semester_total` | **GENERATED** | ูุญุณูุจ ุขููุงู = work + final | **70.80** |
| ุงูุญุงูุฉ | `grading_status_id` | TINYINT (FK) | ูุณูุฏุฉ/ูุฑุงุฌุนุฉ/ูุนุชูุฏ | 3 (ูุนุชูุฏ) |

#### ๐ ุจูุงูุงุช ุงุณุชุฑุดุงุฏูุฉ
| id | enrollment_id | subject_id | semester_id | work_total | final_exam | **semester_total** | status |
|----|---------------|------------|-------------|------------|------------|---------------------|--------|
| 1 | 1 (ูุญูุฏ) | 1 (ุฑูุงุถูุงุช) | 1 | 32.80 | 38.00 | **70.80** | ูุนุชูุฏ |
| 2 | 1 (ูุญูุฏ) | 2 (ุนุฑุจู) | 1 | 31.80 | 40.00 | **71.80** | ูุนุชูุฏ |
| 3 | 2 (ูุฑูู) | 1 (ุฑูุงุถูุงุช) | 1 | 27.50 | 35.00 | **62.50** | ูุนุชูุฏ |
| 4 | 1 (ูุญูุฏ) | 1 (ุฑูุงุถูุงุช) | 2 | 34.00 | 41.20 | **75.20** | ูุณูุฏุฉ |

---

### 2๏ธโฃ ุญุงูุงุช ูุชูุฌุฉ ุงููุงุฏุฉ (lookup_annual_statuses)

| id | name_ar | code |
|----|---------|------|
| 1 | ูุงุฌุญ | PASS |
| 2 | ุฑุงุณุจ | FAIL |
| 3 | ูููู | MAKEUP |
| 4 | ูุญุฑูู ุจุณุจุจ ุงูุบูุงุจ | DEPRIVED |

---

### 3๏ธโฃ ๐ ูุชูุฌุฉ ุงูุนุงู ููู ูุงุฏุฉ (annual_grades)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู | ูุซุงู |
|-------|---------------|-------|-------|------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ | 1 |
| ุงูุทุงูุจ | `enrollment_id` | INT (FK) | ุชุณุฌูู ุงูุทุงูุจ | 1 |
| ุงููุงุฏุฉ | `subject_id` | INT (FK) | ุงููุงุฏุฉ | 1 (ุฑูุงุถูุงุช) |
| ุงูุนุงู | `academic_year_id` | INT (FK) | ุงูุนุงู ุงูุฏุฑุงุณู | 1 |
| ุงููุตู ุงูุฃูู | `semester1_total` | DECIMAL(5,2) | ุฅุฌูุงูู ุงููุตู 1 | 70.80 |
| ุงููุตู ุงูุซุงูู | `semester2_total` | DECIMAL(5,2) | ุฅุฌูุงูู ุงููุตู 2 | 75.20 |
| ุงููุฌููุน | `annual_total` | **GENERATED** | ุงููุตู1 + ุงููุตู2 | **146.00** |
| ุงููุณุจุฉ | `annual_percentage` | DECIMAL(5,2) | ุงููุณุจุฉ ุงููุฆููุฉ | 83.43% |
| ุงูุญุงูุฉ | `final_status_id` | TINYINT (FK) | ูุงุฌุญ/ุฑุงุณุจ/ูููู/ูุญุฑูู | 1 (ูุงุฌุญ) |

#### ๐ ุจูุงูุงุช ุงุณุชุฑุดุงุฏูุฉ
| enrollment_id | subject_id | sem1_total | sem2_total | **annual_total** | percentage | status |
|---------------|------------|------------|------------|-------------------|------------|--------|
| 1 (ูุญูุฏ) | 1 (ุฑูุงุถูุงุช) | 70.80 | 75.20 | **146.00** | 83.43% | โ ูุงุฌุญ |
| 1 (ูุญูุฏ) | 2 (ุนุฑุจู) | 71.80 | 68.50 | **140.30** | 80.17% | โ ูุงุฌุญ |
| 2 (ูุฑูู) | 1 (ุฑูุงุถูุงุช) | 62.50 | 58.00 | **120.50** | 68.86% | โ ูุงุฌุญ |
| 3 (ุนูุฑ) | 1 (ุฑูุงุถูุงุช) | 6.50 | 15.00 | **21.50** | 12.29% | โ ุฑุงุณุจ |

---

### 4๏ธโฃ ูุฑุงุฑุงุช ุงูููู (lookup_promotion_decisions)

| id | name_ar | code | ุงูุดุฑุท |
|----|---------|------|-------|
| 1 | ูููู ููุตู ุงูุชุงูู | PROMOTED | 0 ููุงุฏ ุฑุงุณุจ |
| 2 | ูุนูุฏ ุงูุณูุฉ | RETAINED | ุฃูุซุฑ ูู 2 ููุงุฏ ุฑุงุณุจ |
| 3 | ูููุตู | DISMISSED | ูุฑุงุฑ ุฅุฏุงุฑู |
| 4 | ูููู ุจุดุฑูุท (ูููู) | CONDITIONAL | 1-2 ููุงุฏ ุฑุงุณุจ |

---

### 5๏ธโฃ ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ุงูุดุงููุฉ (annual_result)

| ุงูุญูู | ุงูุงุณู ุงูุจุฑูุฌู | ุงูููุน | ุงููุตู | ูุซุงู |
|-------|---------------|-------|-------|------|
| ุงููุนุฑู | `id` | INT (PK) | ูุนุฑู ูุฑูุฏ | 1 |
| ุงูุทุงูุจ | `enrollment_id` | INT (FK) | ุชุณุฌูู ุงูุทุงูุจ | 1 |
| ุงูุนุงู | `academic_year_id` | INT (FK) | ุงูุนุงู ุงูุฏุฑุงุณู | 1 |
| ูุฌููุน ูู ุงูููุงุฏ | `total_all_subjects` | DECIMAL(7,2) | ูุฌููุน ูู ุงูููุงุฏ | 730.50 |
| ุงูุฏุฑุฌุฉ ุงูุนุธูู | `max_possible_total` | DECIMAL(7,2) | ุงููุฌููุน ุงูููู ุงููููู | 900.00 |
| ุงููุณุจุฉ | `percentage` | DECIMAL(5,2) | ุงููุณุจุฉ ุงูุนุงูุฉ | 81.17% |
| ุชุฑุชูุจ ุงููุตู | `rank_in_class` | SMALLINT | ุชุฑุชูุจ ูู ุงูุดุนุจุฉ | 3 |
| ุชุฑุชูุจ ุงูุตู | `rank_in_grade` | SMALLINT | ุชุฑุชูุจ ูู ูู ุงูุดุนุจ | 8 |
| ููุงุฏ ูุงุฌุญ | `passed_subjects_count` | TINYINT | ุนุฏุฏ ุงูููุงุฏ ุงููุงุฌุญ ูููุง | 9 |
| ููุงุฏ ุฑุงุณุจ | `failed_subjects_count` | TINYINT | ุนุฏุฏ ุงูููุงุฏ ุงูุฑุงุณุจ ูููุง | 0 |
| ุงููุฑุงุฑ | `promotion_decision_id` | TINYINT (FK) | ูุฑุงุฑ ุงูููู | 1 (ูููู) |

#### ๐ ุจูุงูุงุช ุงุณุชุฑุดุงุฏูุฉ
| enrollment | total | max | percentage | rank | passed | failed | **ุงููุฑุงุฑ** |
|------------|-------|-----|------------|------|--------|--------|------------|
| 1 (ูุญูุฏ) | 730.50 | 900.00 | 81.17% | 3 | 9 | 0 | โ ูููู |
| 2 (ูุฑูู) | 650.00 | 900.00 | 72.22% | 7 | 9 | 0 | โ ูููู |
| 3 (ุนูุฑ) | 420.00 | 900.00 | 46.67% | 15 | 6 | 3 | โ ูุนูุฏ |
| 4 (ุณุงุฑุฉ) | 510.00 | 900.00 | 56.67% | 12 | 7 | 2 | โ๏ธ ูุดุฑูุท |

---

## โก Stored Procedures

### sp_calculate_semester_totals
```sql
-- ุญุณุงุจ ูุฌููุน ุฃุนูุงู ุงููุตู ุขููุงู ูู ุงููุญุตูุงุช ุงูุดูุฑูุฉ
CALL sp_calculate_semester_totals(
    1,  -- semester_id
    1,  -- subject_id
    1   -- classroom_id
);
```

### sp_calculate_annual_results
```sql
-- ุญุณุงุจ ุงููุชูุฌุฉ ุงูุณูููุฉ + ุงูุชุฑุชูุจ + ูุฑุงุฑ ุงูููู
CALL sp_calculate_annual_results(
    1,  -- academic_year_id
    1   -- classroom_id
);
```

**ูููู ุจู:**
1. ุชุฌููุน `semester1_total` + `semester2_total` ููู ูุงุฏุฉ โ `annual_grades`
2. ุชุญุฏูุฏ ุงูุญุงูุฉ: ูุงุฌุญ / ุฑุงุณุจ (ุจูุงุกู ุนูู `passing_score` ูู ุงูุณูุงุณุฉ)
3. ุชุฌููุน ูู ุงูููุงุฏ โ `annual_result`
4. ุชุญุฏูุฏ `promotion_decision` (0 ุฑุงุณุจ = ููููุ 1-2 = ูุดุฑูุทุ 3+ = ูุนูุฏ)
5. ุญุณุงุจ ุงูุชุฑุชูุจ ุฏุงุฎู ุงููุตู

---

### sp_fill_final_exam_score
```sql
-- ุณุญุจ ุฏุฑุฌุงุช ุงุฎุชุจุงุฑุงุช FINAL ุฅูู semester_grades
CALL sp_fill_final_exam_score(
    1,  -- semester_id
    1   -- classroom_id
);
```

**ูููู ุจู:**
1. ุฌูุจ `grade_level_id` ู `academic_year_id` ูููุตู.
2. ุฌูุน ุฏุฑุฌุงุช ุงูุทูุงุจ ูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ููุนูุง `FINAL`.
3. ุชุญุฏูุซ `semester_grades.final_exam_score` ููู ุทุงูุจ/ูุงุฏุฉ ูู ุงููุตู.

---

## ๐ View ุฅุถุงูู

### v_sgas_class_ranking
- View ุฌุงูุฒ ูุนุฑุถ ุงูุชุฑุชูุจ ุงูููุงุฆู ููุทูุงุจ ูู ุงููุตู.
- ูุฏูุฌ `annual_result` ูุน `student_enrollments` ู`lookup_promotion_decisions` ู`lookup_grading_statuses`.
- ูุนุฑุถ ุจูุงูุงุช ุงููุฑุงุฑ (`promotion_decision_name`) ูุญุงูุฉ ุงูุงุนุชูุงุฏ (`grading_status_name`) ุจุชุฑุชูุจ ุชูุงุฒูู ุญุณุจ ุงููุณุจุฉ.

---

## ๐ก ุฃูุซูุฉ SQL

### ุฌูุจ ูุชูุฌุฉ ุงูุนุงู ูุทุงูุจ ูุนูู
```sql
SELECT 
    sub.name_ar AS subject_name,
    ag.semester1_total, ag.semester2_total, ag.annual_total,
    ag.annual_percentage,
    las.name_ar AS status
FROM annual_grades ag
JOIN subjects sub ON ag.subject_id = sub.id
JOIN lookup_annual_statuses las ON ag.final_status_id = las.id
WHERE ag.enrollment_id = 1
ORDER BY sub.name_ar;
```

### ูุงุฆูุฉ ุงูุฑุงุณุจูู ูู ุตู ูุนูู
```sql
SELECT 
    s.full_name, ar.percentage, ar.failed_subjects_count,
    lpd.name_ar AS decision
FROM annual_result ar
JOIN student_enrollments se ON ar.enrollment_id = se.id
JOIN students s ON se.student_id = s.id
JOIN lookup_promotion_decisions lpd ON ar.promotion_decision_id = lpd.id
WHERE se.classroom_id = 1 AND ar.promotion_decision_id != 1
ORDER BY ar.percentage;
```

---

## ๐งฉ ุนูุงุตุฑ ุชูููุฉ ุฅุถุงููุฉ ููุซูุฉ
- `semester_grades` ูุญุชูู ุฃูุถุงู ุนูู: `approved_by_user_id`, `approved_at`, `created_at`, `updated_at`.
- `annual_grades` ูุญุชูู ุฃูุถุงู ุนูู: `calculated_at`, `approved_by_user_id`, `approved_at`, `created_at`, `updated_at`.
- `annual_result` ูุญุชูู ุฃูุถุงู ุนูู: `notes`, `approved_by_user_id`, `approved_at`, `created_at`, `updated_at`.

**ุชู ุงูุชุญุฏูุซ:** 2026-02-14
