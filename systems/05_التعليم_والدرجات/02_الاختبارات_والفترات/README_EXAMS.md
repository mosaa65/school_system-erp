# الاختبارات والفترات (Subsystem 02)
## `DDL_EXAMS.sql`

هذا النظام الفرعي يدير دورة الاختبار كاملة: فتح الفترة، إدخال الدرجات، المراجعة، ثم القفل.

## شرح مبسط
- المدرسة تنشئ فترة اختبار (شهري/نهائي/منتصف).
- جدول الاختبارات التفصيلي يأتي من نظام الامتحانات (`exam_timetable` في System 08).
- هنا يتم رصد درجة كل طالب على الاختبار.
- بعد اعتماد الفترة، يتم القفل ومنع أي تعديل.

## الجداول الأساسية

| الجدول | وظيفته |
|---|---|
| `lookup_exam_period_statuses` | حالات سير الفترة (مسودة، جدولة، إدخال، مراجعة، معتمد) |
| `exam_periods` | تعريف الفترات الامتحانية ونطاقها وحالتها |
| `student_exam_scores` | درجات الطلاب الفعلية لكل اختبار |

## ضوابط الحوكمة داخل هذا النظام

| الضابط | كيف يعمل؟ |
|---|---|
| سقف الدرجة | يمنع إدخال درجة أعلى من `max_score` للاختبار |
| قفل الفترة | يمنع التعديل/الحذف إذا `is_locked = 1` |
| تكليف المعلم | يتحقق أن المستخدم الحالي معلم مكلف على المادة والشعبة |
| اختبار صف كامل | يدعم اختبار صف كامل (كل الشعب) عند عدم تحديد شعبة في الجدول الزمني |

## شرح الجداول والأعمدة

### 1) `lookup_exam_period_statuses`
| العمود | الترجمة | الهدف |
|---|---|---|
| `code` | الرمز | قيمة تقنية ثابتة مثل `DRAFT` |
| `name_ar` | الاسم العربي | اسم الحالة للمستخدم |
| `description` | الوصف | شرح مرحلة العمل |
| `sort_order` | ترتيب العرض | ترتيب الحالات في الواجهة |
| `is_active` | التفعيل | تشغيل/إيقاف الحالة |

### 2) `exam_periods`
| العمود | الترجمة | الهدف |
|---|---|---|
| `academic_year_id` | العام الدراسي | نطاق الفترة |
| `semester_id` | الفصل الدراسي | ربط الفترة بالفصل |
| `name_ar` | اسم الفترة | مثل: اختبار شهر محرم |
| `exam_type_id` | نوع الفترة | شهري/منتصف/نهائي |
| `start_date`, `end_date` | نطاق زمني | الإطار العام للفترة |
| `status_id` | حالة العمل | أين وصلت الدورة |
| `is_locked` | قفل الفترة | منع التعديل بعد الاعتماد |
| `locked_at`, `locked_by_user_id` | بيانات القفل | متى ومن قفل الفترة |

### 3) `student_exam_scores`
| العمود | الترجمة | الهدف |
|---|---|---|
| `exam_timetable_id` | مرجع الاختبار | الربط بالاختبار المجدول |
| `enrollment_id` | مرجع الطالب المقيد | الطالب داخل الشعبة |
| `score` | الدرجة | الدرجة الفعلية |
| `is_present` | حاضر/غائب | حالة حضور الاختبار |
| `absence_type` | نوع الغياب | بعذر أو بدون عذر |
| `excuse_details` | تفاصيل العذر | توثيق سبب الغياب |
| `teacher_notes` | ملاحظات المعلم | ملاحظات نوعية |

## سير العملية
1. إنشاء فترة اختبار وتحديد الحالة `مسودة`.
2. جدولة الاختبارات التفصيلية في نظام الامتحانات.
3. فتح إدخال الدرجات (حالة `قيد إدخال الدرجات`).
4. إدخال درجات الطلاب ومراجعتها.
5. تحويل الحالة إلى `معتمدة` ثم قفل الفترة.

## سجلات توضيحية

### حالات الفترات (`lookup_exam_period_statuses`)
| id | code | name_ar | sort_order |
|---|---|---|---:|
| 1 | DRAFT | مسودة | 1 |
| 2 | SCHEDULING | قيد الجدولة | 2 |
| 3 | SCORING | قيد إدخال الدرجات | 3 |
| 4 | REVIEW | قيد المراجعة | 4 |
| 5 | APPROVED | معتمدة | 5 |

### عينة فترات (`exam_periods`)
| id | academic_year_id | semester_id | name_ar | exam_type_id | start_date | end_date | status_id | is_locked |
|---|---:|---:|---|---:|---|---|---:|---:|
| 11 | 1 | 1 | اختبار محرم | 1 | 2026-09-01 | 2026-09-07 | 5 | 1 |
| 12 | 1 | 1 | اختبار صفر | 1 | 2026-10-01 | 2026-10-07 | 3 | 0 |
| 13 | 1 | 1 | اختبار منتصف الفصل | 2 | 2026-11-01 | 2026-11-05 | 2 | 0 |
| 14 | 1 | 1 | اختبار نهائي الفصل الأول | 3 | 2026-12-10 | 2026-12-20 | 1 | 0 |
| 15 | 1 | 2 | اختبار نهائي الفصل الثاني | 3 | 2027-05-10 | 2027-05-20 | 1 | 0 |

### عينة 10 درجات طلاب (`student_exam_scores`)
| id | exam_timetable_id | enrollment_id | score | is_present | absence_type | teacher_notes |
|---|---:|---:|---:|---:|---|---|
| 9001 | 301 | 5001 | 18.0 | 1 | NULL | جيد جدًا |
| 9002 | 301 | 5002 | 15.0 | 1 | NULL | مقبول |
| 9003 | 301 | 5003 | 0.0 | 0 | بدون_عذر | غياب |
| 9004 | 302 | 5001 | 17.0 | 1 | NULL | ثابت المستوى |
| 9005 | 302 | 5002 | 13.0 | 1 | NULL | يحتاج متابعة |
| 9006 | 302 | 5003 | 16.0 | 1 | NULL | تحسن ملحوظ |
| 9007 | 303 | 5001 | 19.0 | 1 | NULL | ممتاز |
| 9008 | 303 | 5002 | 14.0 | 1 | NULL | جيد |
| 9009 | 304 | 5001 | 35.0 | 1 | NULL | نهائي |
| 9010 | 305 | 5002 | 31.0 | 1 | NULL | نهائي |
