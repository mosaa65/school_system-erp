# المحصلة الشهرية (Subsystem 04)
## `DDL_MONTHLY.sql`

هذا النظام الفرعي يحوّل بيانات الشهر إلى درجة شهرية موحدة لكل طالب في كل مادة.

## شرح مبسط
- يجمع تلقائيًا: الحضور + الواجب + الاختبار.
- يضيف يدويًا: النشاط + المساهمة.
- يمكن إضافة درجات مكونات مخصصة حسب سياسة المدرسة.
- الناتج النهائي يحفظ في `monthly_total` ويصبح جاهزًا لنتيجة الفصل.

## الجداول الأساسية

| الجدول | وظيفته |
|---|---|
| `monthly_grades` | السجل الشهري النهائي لكل طالب ومادة |
| `monthly_custom_component_scores` | درجات الجوانب المخصصة للشهر |

## مصادر الحساب الآلي

| المصدر | كيف يدخل في الحساب؟ |
|---|---|
| `student_attendance` | يمر عبر `v_auto_attendance_score` |
| `student_homeworks` | يمر عبر `v_auto_homework_score` |
| `student_exam_scores` | يؤخذ فقط من فترات الشهر المعنية |
| سياسة الدرجات | تحدد السقف الأعلى لكل عنصر |

## شرح الجداول والأعمدة

### 1) `monthly_grades`
| العمود | الترجمة | الهدف |
|---|---|---|
| `enrollment_id` | الطالب المقيد | صاحب الدرجة |
| `subject_id` | المادة | المادة محل التقييم |
| `month_id` | الشهر الأكاديمي | نطاق الحساب |
| `semester_id` | الفصل (مكرر للتسريع) | تسريع التقارير |
| `academic_year_id` | العام (مكرر للتسريع) | تسريع الاستعلامات |
| `attendance_score` | درجة المواظبة | محسوبة من الحضور |
| `homework_score` | درجة الواجب | محسوبة من الواجبات |
| `activity_score` | درجة النشاط | إدخال يدوي للمعلم |
| `contribution_score` | درجة المساهمة | إدخال يدوي للمعلم |
| `custom_components_score` | مجموع المكونات المخصصة | يجمع من جدول المكونات |
| `exam_score` | درجة الاختبار الشهري | محسوبة من نتائج الاختبار |
| `monthly_total` | المجموع الشهري | عمود محسوب تلقائيًا |

### 2) `monthly_custom_component_scores`
| العمود | الترجمة | الهدف |
|---|---|---|
| `enrollment_id` | الطالب | صاحب الدرجة |
| `subject_id` | المادة | مادة المكون |
| `month_id` | الشهر | نطاق زمني |
| `policy_component_id` | مكوّن السياسة | أي عنصر مخصص تم تقييمه |
| `score` | درجة العنصر | الدرجة الفعلية |
| `notes` | ملاحظات | شرح سبب الدرجة |
| `created_by_user_id` | من أدخل الدرجة | تتبع المسؤول |

## سير العملية
1. تشغيل الحساب الشهري للشعبة/المادة.
2. النظام يقرأ الحضور والواجب والاختبارات تلقائيًا.
3. المعلم يكمل النشاط والمساهمة.
4. إدخال المكونات المخصصة ضمن سقف السياسة.
5. الناتج النهائي ينتقل تلقائيًا لنظام نتائج الفصل.

## سجلات توضيحية

### عينة 10 سجلات شهرية (`monthly_grades`)
| id | enrollment_id | subject_id | month_id | semester_id | academic_year_id | attendance_score | homework_score | activity_score | contribution_score | custom_components_score | exam_score | monthly_total |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 30001 | 5001 | 3 | 1 | 1 | 1 | 5.0 | 4.5 | 3.0 | 2.0 | 1.0 | 7.0 | 22.5 |
| 30002 | 5002 | 3 | 1 | 1 | 1 | 4.2 | 4.0 | 2.5 | 1.5 | 0.5 | 6.5 | 19.2 |
| 30003 | 5003 | 3 | 1 | 1 | 1 | 3.8 | 3.5 | 2.0 | 1.0 | 0.5 | 5.0 | 15.8 |
| 30004 | 5004 | 3 | 1 | 1 | 1 | 5.0 | 4.8 | 3.0 | 2.0 | 1.0 | 7.2 | 23.0 |
| 30005 | 5005 | 3 | 1 | 1 | 1 | 4.7 | 4.1 | 2.8 | 1.8 | 0.7 | 6.8 | 20.9 |
| 30006 | 5006 | 3 | 1 | 1 | 1 | 4.0 | 3.9 | 2.3 | 1.2 | 0.4 | 6.0 | 17.8 |
| 30007 | 5007 | 3 | 1 | 1 | 1 | 3.5 | 3.0 | 1.8 | 0.8 | 0.3 | 4.5 | 13.9 |
| 30008 | 5008 | 3 | 1 | 1 | 1 | 4.8 | 4.6 | 2.9 | 1.9 | 0.8 | 7.1 | 22.1 |
| 30009 | 5009 | 3 | 1 | 1 | 1 | 4.1 | 3.7 | 2.2 | 1.4 | 0.6 | 5.9 | 17.9 |
| 30010 | 5010 | 3 | 1 | 1 | 1 | 5.0 | 4.9 | 3.0 | 2.0 | 1.0 | 7.4 | 23.3 |

### عينة 10 مكونات مخصصة (`monthly_custom_component_scores`)
| id | enrollment_id | subject_id | month_id | policy_component_id | score | notes | created_by_user_id |
|---|---:|---:|---:|---:|---:|---|---:|
| 4501 | 5001 | 3 | 1 | 101 | 1.0 | التزام ممتاز | 12 |
| 4502 | 5002 | 3 | 1 | 101 | 0.5 | متوسط | 12 |
| 4503 | 5003 | 3 | 1 | 101 | 0.5 | يحتاج متابعة | 12 |
| 4504 | 5004 | 3 | 1 | 101 | 1.0 | ممتاز | 12 |
| 4505 | 5005 | 3 | 1 | 101 | 0.7 | جيد | 12 |
| 4506 | 5006 | 3 | 1 | 101 | 0.4 | مقبول | 12 |
| 4507 | 5007 | 3 | 1 | 101 | 0.3 | ضعيف | 12 |
| 4508 | 5008 | 3 | 1 | 101 | 0.8 | جيد جدًا | 12 |
| 4509 | 5009 | 3 | 1 | 101 | 0.6 | تحسن واضح | 12 |
| 4510 | 5010 | 3 | 1 | 101 | 1.0 | مستوى عالٍ | 12 |

## ضوابط مهمة
- لا تُقبل درجة سالبة.
- لا يُسمح بتجاوز سقف المكوّن المخصص.
- لا يُسمح بإدخال مكوّن لا يتبع سياسة الطالب/المادة/الشهر.
- التعديل اليدوي للنشاط والمساهمة مقيد بصلاحية المعلم المكلف.
